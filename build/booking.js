(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.domReady;var n=e.n(t);const s=window.wp.element,a=window.wp.i18n,o=window.wp.components,i=window.ReactJSXRuntime,l=({day:e,isSelected:t,isToday:n,onClick:s})=>(0,i.jsxs)("button",{type:"button",className:`day-button ${t?"selected":""} ${n?"today":""}`,onClick:()=>s(e.jalali_date),children:[(0,i.jsx)("div",{className:"day-name",children:e?.weekday}),(0,i.jsx)("div",{className:"day-number",children:e?.day_number}),(0,i.jsx)("div",{className:"month-name",children:e?.month_name})]}),d=e=>{if(!e)return e;const t=e.split(":");return t.length>2?`${t[0]}:${t[1]}`:e},c=({slot:e,isSelected:t,onClick:n})=>{const{start_time:s,end_time:o,status:l}=e,c="booked"===l,r=d(s),m=d(o);return c?(0,i.jsx)("span",{className:"time-slot-button booked",disabled:!0,children:(0,i.jsxs)("div",{className:"slot-time-display",children:[(0,i.jsx)("div",{className:"time-start",children:r}),(0,i.jsx)("div",{className:"time-separator",children:(0,a.__)("to","nobat")}),(0,i.jsx)("div",{className:"time-end",children:m})]})}):(0,i.jsx)("button",{type:"button",className:`time-slot-button ${l} ${t?"selected":""}`,onClick:()=>n(e),disabled:"available"!==l,children:(0,i.jsxs)("div",{className:"slot-time-display",children:[(0,i.jsx)("div",{className:"time-start",children:r}),(0,i.jsx)("div",{className:"time-separator",children:(0,a.__)("to","nobat")}),(0,i.jsx)("div",{className:"time-end",children:m})]})})},r=({schedule:e,onSlotSelect:t})=>{const[n,o]=(0,s.useState)(null),[d,r]=(0,s.useState)(null),m=e=>{o(e),r(null)},u=e=>{r(e)};if((0,s.useEffect)(()=>{t?.(n&&d?{slotId:d.id,scheduleId:d.schedule_id,date:n,timeSlot:`${d.start_time}-${d.end_time}`,slotData:d}:null)},[n,d,t]),!e||!e.days||0===e.days.length)return(0,i.jsx)("div",{className:"no-slots",children:(0,a.__)("No available dates","nobat")});const p=n?e.days.find(e=>e.jalali_date===n):null,h=p?(p.slots||[]).filter(e=>"available"===e.status):[];return(0,i.jsxs)("div",{className:"appointment-selector",children:[(0,i.jsx)("div",{className:"week-days-selector",children:(0,i.jsx)("div",{className:"week-days-grid",children:e.days.map(e=>{if(0===(e.slots||[]).filter(e=>"available"===e.status).length)return null;const t=n===e.jalali_date;return(0,i.jsx)(l,{day:e,isSelected:t,isToday:!1,onClick:m},e.jalali_date)})})}),p&&h.length>0&&(0,i.jsxs)("div",{className:"time-slots-container",children:[(0,i.jsx)("span",{className:"date-selector-label",children:(0,a.__)("Available Hours","nobat")}),(0,i.jsx)("div",{className:"time-slots-grid",children:h.map(e=>{const t=d&&d.id===e.id;return(0,i.jsx)(c,{slot:e,isSelected:t,onClick:u},e.id)})})]})]})},m=({scheduleId:e,onSuccess:t,onBack:n})=>{const{formData:l,loading:d,message:c,messageType:m,bookedAppointment:u,isLoggedIn:p,handleInputChange:h,submitBooking:_,clearMessage:b,getMinDate:x,isFormValid:j}=(()=>{const[e,t]=(0,s.useState)({slot_id:"",schedule_id:"",note:""}),[n,a]=(0,s.useState)(!1),[o,i]=(0,s.useState)(null),[l,d]=(0,s.useState)("success"),[c,r]=(0,s.useState)(null),[m,u]=(0,s.useState)(!(!window.nobatBooking||!window.nobatBooking.isLoggedIn)),p=(0,s.useCallback)((e,n)=>{t(t=>({...t,[e]:n})),c&&r(null)},[c]),h=(0,s.useCallback)(()=>m?!(!e.slot_id||!e.schedule_id)||(i("Please select a time slot"),d("error"),!1):(i("You must be logged in to book appointments"),d("error"),!1),[e,m]),_=(0,s.useCallback)(async()=>{if(!h())return!1;try{a(!0);const n={slot_id:parseInt(e.slot_id),schedule_id:parseInt(e.schedule_id)};e.note&&""!==e.note.trim()&&(n.note=e.note.trim());const s=await fetch("/wp-json/nobat/v2/appointments",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-WP-Nonce":window.nobatBooking?.nonce||""},body:JSON.stringify(n)}),o=await s.json();if(!s.ok){if("not_logged_in"===o.code)return i("You must be logged in to book appointments. Redirecting to login..."),d("error"),setTimeout(()=>{window.location.href="/wp-login.php?redirect_to="+encodeURIComponent(window.location.href)},2e3),!1;if("max_appointments_reached"===o.code)return i(o.message||"You have reached the maximum of 3 active appointments"),d("error"),!1;throw new Error(o.message||"Failed to book appointment")}return r(o.appointment),i(o.message||"Appointment booked successfully!"),d("success"),t({slot_id:"",schedule_id:"",note:""}),!0}catch(e){return console.error("Booking error:",e),i(e.message||"Failed to book appointment. Please try again."),d("error"),!1}finally{a(!1)}},[e,h]),b=(0,s.useCallback)(()=>{i(null)},[]),x=(0,s.useCallback)(()=>{t({slot_id:"",schedule_id:"",note:""}),r(null),i(null)},[]),j=(0,s.useCallback)(()=>(new Date).toISOString().split("T")[0],[]),g=(0,s.useMemo)(()=>!!(m&&e.slot_id&&e.schedule_id),[m,e.slot_id,e.schedule_id]);return{formData:e,loading:n,message:o,messageType:l,bookedAppointment:c,isLoggedIn:m,handleInputChange:p,submitBooking:_,clearMessage:b,resetForm:x,getMinDate:j,isFormValid:g}})(),{schedule:g,loading:f,error:v,refetch:w}=(()=>{const[e,t]=(0,s.useState)(null),[n,a]=(0,s.useState)(!0),[o,i]=(0,s.useState)(null),l=(0,s.useCallback)(async()=>{try{a(!0),i(null);const e="/wp-json/nobat/v2/schedules/active";console.log("Nobat: Fetching active schedule from",e);const n=await fetch(e,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});if(!n.ok){if(404===n.status)throw new Error("No active schedule found. Please contact the administrator.");const e=await n.json().catch(()=>({}));throw new Error(e.message||"Failed to fetch schedule")}const s=await n.json();if(console.log("Nobat: Schedule data received",s),!s.success||!s.schedule)throw new Error("Invalid response format");{const e=(s.schedule.timeslots||[]).map(e=>({...e,slots:(e.slots||[]).map(e=>({...e,start_time:e.start||e.start_time,end_time:e.end||e.end_time}))})),n={...s.schedule,days:e};delete n.timeslots,console.log("Nobat: Transformed schedule",n),t(n)}}catch(e){console.error("Error fetching schedule:",e);const n=e.message||"Failed to load schedule";i(n),t(null)}finally{a(!1)}},[]);return(0,s.useEffect)(()=>{l()},[l]),{schedule:e,loading:n,error:o,refetch:l}})();return p?(0,i.jsx)("div",{className:"appointment-booking-form",children:(0,i.jsxs)(o.Card,{children:[(0,i.jsx)(o.CardHeader,{children:(0,i.jsxs)("div",{className:"card-header-content",children:[(0,i.jsx)("h3",{children:(0,a.__)("Book an Appointment","nobat")}),(0,i.jsx)("div",{className:"header-actions",children:n&&(0,i.jsxs)(o.Button,{variant:"secondary",onClick:n,className:"back-button",size:"compact",children:["â† ",(0,a.__)("See My Appointments","nobat")]})})]})}),(0,i.jsxs)(o.CardBody,{children:[c&&"success"===m&&window.nobatBooking?.successMessage?(0,i.jsx)("div",{className:"custom-success-message",children:(0,i.jsx)("div",{dangerouslySetInnerHTML:{__html:window.nobatBooking.successMessage}})}):c?(0,i.jsx)(o.Notice,{status:m,isDismissible:!0,onRemove:b,children:c}):null,(0,i.jsxs)("form",{onSubmit:async e=>{e.preventDefault(),await _()&&t&&(window.nobatBooking?.successMessage||setTimeout(()=>{t()},1500))},className:"booking-form",children:[f?(0,i.jsxs)("div",{className:"loading-slots",children:[(0,i.jsx)(o.Spinner,{}),(0,i.jsx)("span",{children:(0,a.__)("Loading available slots...","nobat")})]}):v?(0,i.jsxs)("div",{className:"form-row",children:[(0,i.jsx)(o.Notice,{status:"error",isDismissible:!1,children:v}),(0,i.jsx)("div",{className:"form-actions",children:(0,i.jsx)(o.Button,{onClick:w,variant:"secondary",__next40pxDefaultSize:!0,children:(0,a.__)("Retry","nobat")})})]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"form-row",children:[(0,i.jsx)("span",{className:"date-selector-label",children:(0,a.__)("Select a Time Slot","nobat")}),(0,i.jsx)(r,{schedule:g,onSlotSelect:e=>{e?(h("slot_id",e.slotId),h("schedule_id",e.scheduleId)):(h("slot_id",""),h("schedule_id",""))}})]}),(0,i.jsx)("div",{className:"form-row",children:(0,i.jsx)(o.TextareaControl,{label:(0,a.__)("Note (Optional)","nobat"),value:l.note,onChange:e=>h("note",e),placeholder:(0,a.__)("Add any additional information or special requests","nobat"),rows:3})})]}),(0,i.jsx)("div",{className:"form-actions",children:(0,i.jsx)(o.Button,{type:"submit",variant:"primary",disabled:d||f||!!v||!j,__next40pxDefaultSize:!0,children:d?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(o.Spinner,{}),(0,a.__)("Booking...","nobat")]}):(0,a.__)("Book Appointment","nobat")})})]})]})]})}):(0,i.jsx)("div",{className:"appointment-booking-form",children:(0,i.jsxs)(o.Card,{children:[(0,i.jsx)(o.CardHeader,{children:(0,i.jsx)("h3",{children:(0,a.__)("Book an Appointment","nobat")})}),(0,i.jsxs)(o.CardBody,{children:[(0,i.jsx)(o.Notice,{status:"warning",isDismissible:!1,children:(0,i.jsx)("p",{children:(0,a.__)("You must be logged in to book appointments.","nobat")})}),(0,i.jsxs)("div",{className:"form-actions",style:{marginTop:"16px"},children:[(0,i.jsx)(o.Button,{variant:"primary",href:"/wp-login.php?redirect_to="+encodeURIComponent(window.location.href),__next40pxDefaultSize:!0,children:(0,a.__)("Log In","nobat")}),(0,i.jsx)(o.Button,{variant:"secondary",href:"/wp-login.php?action=register",__next40pxDefaultSize:!0,style:{marginLeft:"8px"},children:(0,a.__)("Register","nobat")})]})]})]})})},u=({shouldLoad:e=!0,onBookNew:t,onAppointmentsLoaded:n})=>{const[l,d]=(0,s.useState)([]),[c,r]=(0,s.useState)(!0),[m,u]=(0,s.useState)(null),[p,h]=(0,s.useState)(!1),[_,b]=(0,s.useState)(null),[x,j]=(0,s.useState)(""),[g,f]=(0,s.useState)(!1),[v,w]=(0,s.useState)(null),[y,N]=(0,s.useState)("success"),[k,S]=(0,s.useState)(!1),C=!(!window.nobatBooking||!window.nobatBooking.isLoggedIn);(0,s.useEffect)(()=>{e&&!k&&C?(B(),S(!0)):C||(r(!1),u("You must be logged in to view your appointments."))},[C,e,k]);const B=async()=>{try{r(!0),u(null);const e=await fetch("/wp-json/nobat/v2/appointments",{method:"GET",credentials:"include",headers:{"Content-Type":"application/json","X-WP-Nonce":window.nobatBooking?.nonce||""}});if(!e.ok){const t=await e.json();throw new Error(t.message||"Failed to fetch appointments")}const t=(await e.json()).appointments||[];d(t),n&&n(t.length)}catch(e){console.error("Error fetching appointments:",e),u(e.message||"Failed to load appointments")}finally{r(!1)}},I=e=>({pending:(0,a.__)("Pending","nobat"),confirmed:(0,a.__)("Confirmed","nobat"),completed:(0,a.__)("Completed","nobat"),cancelled:(0,a.__)("Cancelled","nobat"),cancel_requested:(0,a.__)("Cancellation Requested","nobat")}[e]||e),T=e=>"pending"===e.status||"confirmed"===e.status;return C?(0,i.jsxs)("div",{className:"my-appointments",children:[(0,i.jsxs)(o.Card,{children:[(0,i.jsx)(o.CardHeader,{children:(0,i.jsxs)("div",{className:"card-header-content",children:[(0,i.jsx)("h3",{children:(0,a.__)("My Appointments","nobat")}),(0,i.jsx)("div",{className:"header-actions",children:t&&(0,i.jsx)(o.Button,{variant:"primary",onClick:t,className:"book-new-button",size:"compact",children:(0,a.__)("Book New Appointment","nobat")})})]})}),(0,i.jsxs)(o.CardBody,{children:[v&&(0,i.jsx)(o.Notice,{status:y,isDismissible:!0,onRemove:()=>w(null),children:v}),c?(0,i.jsxs)("div",{className:"loading-appointments",children:[(0,i.jsx)(o.Spinner,{}),(0,i.jsx)("span",{children:(0,a.__)("Loading appointments...","nobat")})]}):m?(0,i.jsx)(o.Notice,{status:"error",isDismissible:!1,children:m}):0===l.length?(0,i.jsx)("div",{className:"no-appointments",children:(0,i.jsx)("p",{children:(0,a.__)("You don't have any appointments yet. Click the button above to book your first appointment.","nobat")})}):(0,i.jsx)("div",{className:"appointments-list",children:l.map(e=>{return(0,i.jsx)(o.Card,{className:"appointment-card",children:(0,i.jsx)(o.CardBody,{children:(0,i.jsxs)("div",{className:"appointment-content",children:[(0,i.jsxs)("div",{className:"appointment-info-group",children:[(0,i.jsxs)("div",{className:"appointment-info",children:[(0,i.jsx)("h4",{children:e.slot_date_jalali||e.slot_date}),(0,i.jsxs)("div",{className:"appointment-time",children:[(0,i.jsx)("div",{className:"time-start",children:e.start_time?e.start_time.substring(0,5):""}),(0,i.jsx)("div",{className:"time-separator",children:(0,a.__)("to","nobat")}),(0,i.jsx)("div",{className:"time-end",children:e.end_time?e.end_time.substring(0,5):""})]})]}),(0,i.jsx)("div",{className:"appointment-status",children:(0,i.jsx)("span",{className:`status-badge ${t=e.status,{pending:"status-pending",confirmed:"status-confirmed",completed:"status-completed",cancelled:"status-cancelled",cancel_requested:"status-cancel-requested"}[t]||"status-default"}`,children:I(e.status)})}),e.note&&(0,i.jsxs)("div",{className:"appointment-note",children:[(0,i.jsx)("strong",{children:(0,a.__)("Note:","nobat")})," ",e.note]}),e.assigned_admin_id&&e.admin_name&&(0,i.jsxs)("div",{className:"appointment-admin",children:[(0,i.jsx)("strong",{children:(0,a.__)("Assigned to:","nobat")})," ",e.admin_name]})]}),T(e)&&(0,i.jsx)("div",{className:"appointment-actions",children:(0,i.jsx)(o.Button,{variant:"outline-destructive",onClick:()=>(e=>{b(e),j(""),h(!0)})(e),size:"compact",children:(0,a.__)("Cancel","nobat")})})]})})},e.id);var t})})]})]}),p&&(0,i.jsxs)(o.Modal,{title:(0,a.__)("Request Cancellation","nobat"),onRequestClose:()=>{g||(h(!1),b(null))},children:[(0,i.jsx)("p",{children:(0,a.__)("Are you sure you want to request cancellation for this appointment?","nobat")}),_&&(0,i.jsxs)("div",{className:"cancellation-appointment-info",children:[(0,i.jsxs)("p",{children:[(0,i.jsx)("strong",{children:(0,a.__)("Date:","nobat")})," ",_.slot_date_jalali||_.slot_date]}),(0,i.jsxs)("p",{children:[(0,i.jsx)("strong",{children:(0,a.__)("Time:","nobat")})," ",_.start_time," - ",_.end_time]})]}),(0,i.jsx)(o.TextareaControl,{label:(0,a.__)("Reason for cancellation (optional)","nobat"),value:x,onChange:e=>j(e),placeholder:(0,a.__)("Please provide a reason for cancellation","nobat"),rows:4}),(0,i.jsxs)("div",{className:"modal-actions",style:{marginTop:"16px"},children:[(0,i.jsx)(o.Button,{variant:"primary",isDestructive:!0,onClick:async()=>{if(_)try{f(!0);const e=await fetch(`/wp-json/nobat/v2/appointments/${_.id}/cancel`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-WP-Nonce":window.nobatBooking?.nonce||""},body:JSON.stringify({reason:x||null})}),t=await e.json();if(!e.ok)throw new Error(t.message||"Failed to request cancellation");w((0,a.__)("Cancellation request submitted successfully!","nobat")),N("success"),h(!1),b(null),B()}catch(e){console.error("Error requesting cancellation:",e),w(e.message||"Failed to submit cancellation request"),N("error")}finally{f(!1)}},disabled:g,__next40pxDefaultSize:!0,children:g?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(o.Spinner,{}),(0,a.__)("Submitting...","nobat")]}):(0,a.__)("Submit Request","nobat")}),(0,i.jsx)(o.Button,{variant:"secondary",onClick:()=>{h(!1),b(null)},disabled:g,__next40pxDefaultSize:!0,style:{marginLeft:"8px"},children:(0,a.__)("Cancel","nobat")})]})]})]}):(0,i.jsx)("div",{className:"my-appointments",children:(0,i.jsxs)(o.Card,{children:[(0,i.jsx)(o.CardHeader,{children:(0,i.jsx)("h3",{children:(0,a.__)("My Appointments","nobat")})}),(0,i.jsxs)(o.CardBody,{children:[(0,i.jsx)(o.Notice,{status:"warning",isDismissible:!1,children:(0,i.jsx)("p",{children:(0,a.__)("You must be logged in to view your appointments.","nobat")})}),(0,i.jsx)("div",{className:"form-actions",style:{marginTop:"16px"},children:(0,i.jsx)(o.Button,{variant:"primary",href:"/wp-login.php?redirect_to="+encodeURIComponent(window.location.href),__next40pxDefaultSize:!0,children:(0,a.__)("Log In","nobat")})})]})]})})},p=({scheduleId:e})=>{const[t,n]=(0,s.useState)("appointments"),[a,o]=(0,s.useState)(null),l=()=>{n("appointments")};return(0,i.jsx)("div",{className:"nobat-booking-view",children:"appointments"===t?(0,i.jsx)("div",{className:"nobat-form",children:(0,i.jsx)(u,{shouldLoad:!0,onBookNew:()=>{n("booking")},onAppointmentsLoaded:e=>{o(e>0),0===e&&n("booking")}})}):(0,i.jsx)("div",{className:"nobat-form",children:(0,i.jsx)(m,{scheduleId:e,onSuccess:()=>{window.nobatBooking?.successMessage||l()},onBack:!1===a?null:l})})})};n()(()=>{const e=document.querySelectorAll(".nobat-booking-container");0!==e.length?e.forEach(e=>{const t=e.querySelector(".nobat-booking-app");if(!t)return void console.warn("Nobat: Booking app container not found",e);const n=e.dataset.scheduleId||"";console.log("Nobat: Initializing booking form",{scheduleId:n}),(0,s.createRoot)(t).render((0,i.jsx)(p,{scheduleId:n}))}):console.warn("Nobat: No booking form containers found on page")})})();