(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var a in n)e.o(n,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:n[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.domReady;var n=e.n(t);const a=window.wp.element,s=window.wp.i18n,o=window.wp.components,l=window.ReactJSXRuntime,i=(0,a.createContext)(null),r=({scheduleId:e,children:t})=>{const n=(e=>{const[t,n]=(0,a.useState)(null),[s,o]=(0,a.useState)(!0),[l,i]=(0,a.useState)(null),r=(0,a.useCallback)(async()=>{try{o(!0),i(null);const t=e?`/wp-json/nobat/v2/schedules/${encodeURIComponent(e)}`:"/wp-json/nobat/v2/schedules/active";console.log("path",t);const a=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",..."undefined"!=typeof window&&window.location.pathname.includes("/wp-admin/")&&"undefined"!=typeof wpApiSettings&&{"X-WP-Nonce":wpApiSettings.nonce}}});if(!a.ok){const e=await a.json().catch(()=>({}));throw new Error(e.message||"Failed to fetch schedule")}const s=await a.json();console.log("API Response:",s);const l=s.schedule||s;n(l)}catch(e){console.error("Error fetching active schedule:",e);const t=e.message||"Failed to load schedule";i(t),n(null)}finally{o(!1)}},[e]);return(0,a.useEffect)(()=>{r()},[r]),{schedule:t,loading:s,error:l,refetch:r}})(e);return(0,l.jsx)(i.Provider,{value:n,children:t})},c=()=>{const e=(0,a.useContext)(i);if(!e)throw new Error("useSchedule must be used within a ScheduleProvider");return e},d=()=>{const{schedule:e}=c();return e&&e.id?(0,l.jsxs)("h2",{children:[e?.name," ",e?Number(e.is_active)?(0,s.__)("(Active)","nobat"):(0,s.__)("(Inactive)","nobat"):null]}):null},p=({timeRows:e})=>(0,l.jsxs)("div",{className:"time-column",children:[(0,l.jsx)("div",{className:"time-header",children:(0,s.__)("Time","nobat")}),e.map((e,t)=>{const{startTime:n,endTime:a}=(e=>{const[t,n]=e.split("-");return{startTime:t?.trim(),endTime:n?.trim()}})(e.key),s=(e=>{const[t]=e.split("-");return t?.trim().endsWith(":00")})(e.key);return(0,l.jsx)("div",{className:"time-slot "+(s?"on-the-hour":""),children:(0,l.jsxs)("div",{className:"time-slot-content",children:[(0,l.jsx)("span",{className:"time-start",children:n}),(0,l.jsx)("span",{className:"time-separator",children:"â€”"}),(0,l.jsx)("span",{className:"time-end",children:a})]})},`slot-${t}`)})]}),m=window.wp.apiFetch;var h=e.n(m);const u=e=>{switch(e){case"pending":return"#f0ad4e";case"confirmed":return"#5cb85c";case"completed":return"#337ab7";case"cancelled":return"#d9534f";default:return"#777"}},b=e=>{switch(e){case"pending":return"#d58512";case"confirmed":return"#449d44";case"completed":return"#286090";case"cancelled":return"#b52b27";default:return"#333333"}},_=e=>{switch(e){case"pending":return(0,s.__)("Pending","nobat");case"confirmed":return(0,s.__)("Confirmed","nobat");case"completed":return(0,s.__)("Completed","nobat");case"cancelled":return(0,s.__)("Cancelled","nobat");default:return e}},x=((0,s.__)("Pending","nobat"),(0,s.__)("Confirmed","nobat"),(0,s.__)("Completed","nobat"),(0,s.__)("Cancelled","nobat"),e=>new Date(e).toLocaleDateString());function g(e){if(!e||"string"!=typeof e)return console.error("gregorianToJalali: Invalid input",e),"";const t=e.split("-");if(3!==t.length)return console.error("gregorianToJalali: Invalid date format",e),"";const n=parseInt(t[0],10),a=parseInt(t[1],10),s=parseInt(t[2],10);if(isNaN(n)||isNaN(a)||isNaN(s))return console.error("gregorianToJalali: Invalid date values",e),"";if(n<1||n>3e3||a<1||a>12||s<1||s>31)return console.error("gregorianToJalali: Date out of range",e),"";try{const[t,o,l]=function(e,t,n){let a,s,o,l;e>1600?(a=979,e-=1600):(a=0,e-=621);const i=t>2?e+1:e;return l=365*e+Math.floor((i+3)/4)-Math.floor((i+99)/100)+Math.floor((i+399)/400)-80+n+[0,31,59,90,120,151,181,212,243,273,304,334][t-1],a+=33*Math.floor(l/12053),l%=12053,a+=4*Math.floor(l/1461),l%=1461,l>365&&(a+=Math.floor((l-1)/365),l=(l-1)%365),l<186?(s=1+Math.floor(l/31),o=1+l%31):(s=7+Math.floor((l-186)/30),o=1+(l-186)%30),[a,s,o]}(n,a,s),i=String(t),r=`${i}/${String(o).padStart(2,"0")}/${String(l).padStart(2,"0")}`;return console.log("gregorianToJalali: Converted",e,"â†’",r),r}catch(e){return console.error("gregorianToJalali: Conversion error",e),""}}const f=({appointment:e,isOpen:t,onClose:n,onStatusUpdate:i,onDelete:r})=>{const[c,d]=(0,a.useState)(!1),[p,m]=(0,a.useState)(e?.report||""),[b,f]=(0,a.useState)(!1),[y,j]=(0,a.useState)(null),[v,w]=(0,a.useState)(!e?.report);if(!e)return null;const k=()=>{const t=`${e.start_time.substring(0,5)}-${e.end_time.substring(0,5)}`,n=(e=>(0,s.__)("Hello {name}, this is regarding your appointment on {date} at {time}.","nobat").replace("{name}",e.client_name).replace("{date}",x(e.appointment_date)).replace("{time}",e.time_slot))({...e,client_name:e.user_name,client_phone:e.user_phone,appointment_date:e.slot_date,time_slot:t}),a=((e,t)=>`https://wa.me/${e.replace(/\D/g,"")}?text=${encodeURIComponent(t)}`)(e.user_phone,n);window.open(a,"_blank")},N=(()=>{const t=e.status,n={confirm:{label:(0,s.__)("Confirm Appointment","nobat"),description:(0,s.__)("Approve and confirm this appointment","nobat"),status:"confirmed",variant:"primary",icon:"âœ“",type:"status"},complete:{label:(0,s.__)("Mark as Completed","nobat"),description:(0,s.__)("Mark this appointment as successfully completed","nobat"),status:"completed",variant:"primary",icon:"âœ“âœ“",type:"status"},cancel:{label:(0,s.__)("Cancel Appointment","nobat"),description:(0,s.__)("Cancel this appointment and free the time slot","nobat"),status:"cancelled",variant:"secondary",isDestructive:!0,icon:"âœ•",type:"status"},restore:{label:(0,s.__)("Restore Appointment","nobat"),description:(0,s.__)("Restore this appointment to confirmed status","nobat"),status:"confirmed",variant:"primary",icon:"â†¶",type:"status"}},a={whatsapp:{label:(0,s.__)("Send WhatsApp Message","nobat"),description:(0,s.__)("Open WhatsApp to message the client","nobat"),variant:"secondary",icon:"ðŸ’¬",type:"communication",className:"whatsapp-action",onClick:k},delete:{label:(0,s.__)("Delete Permanently","nobat"),description:(0,s.__)("Permanently delete this appointment (cannot be undone)","nobat"),variant:"link",isDestructive:!0,icon:null,type:"delete",onClick:()=>d(!0)}};let o=[];switch(t){case"pending":o=[n.confirm,n.cancel];break;case"confirmed":o=[n.complete,n.cancel];break;case"cancel_requested":o=[n.cancel,n.restore];break;case"completed":o=[n.cancel];break;case"cancelled":o=[n.restore];break;default:o=[]}return o.push(a.whatsapp,a.delete),o})();return(0,l.jsxs)(l.Fragment,{children:[t&&(0,l.jsx)(o.Modal,{title:(0,s.__)("Appointment Details","nobat"),isOpen:t,onRequestClose:n,className:"appointment-detail-modal",children:(0,l.jsxs)("div",{className:"appointment-detail-content",children:[(0,l.jsxs)("div",{className:"appointment-info",children:[(0,l.jsxs)("div",{className:"info-row",children:[(0,l.jsx)("strong",{children:(0,s.__)("Client Name:","nobat")}),(0,l.jsx)("span",{children:e.user_id?(0,l.jsx)("a",{href:`/wp-admin/user-edit.php?user_id=${e.user_id}`,target:"_blank",rel:"noopener noreferrer",className:"client-name-link",children:e.user_name}):e.user_name})]}),(0,l.jsxs)("div",{className:"info-row",children:[(0,l.jsx)("strong",{children:(0,s.__)("Phone:","nobat")}),(0,l.jsx)("span",{className:"phone-number",children:e.user_phone})]}),(0,l.jsxs)("div",{className:"info-row",children:[(0,l.jsx)("strong",{children:(0,s.__)("Date:","nobat")}),(0,l.jsx)("span",{className:"date-value",children:g(e.slot_date)||x(e.slot_date)})]}),(0,l.jsxs)("div",{className:"info-row",children:[(0,l.jsx)("strong",{children:(0,s.__)("Time:","nobat")}),(0,l.jsx)("span",{className:"time-slot",children:`${e.start_time.substring(0,5)} - ${e.end_time.substring(0,5)}`})]}),(0,l.jsxs)("div",{className:"info-row",children:[(0,l.jsx)("strong",{children:(0,s.__)("Status:","nobat")}),(0,l.jsx)("span",{className:"status-badge",style:{backgroundColor:u(e.status)},children:_(e.status)})]}),e.admin_name&&(0,l.jsxs)("div",{className:"info-row",children:[(0,l.jsx)("strong",{children:(0,s.__)("Assigned Admin:","nobat")}),(0,l.jsx)("span",{className:"admin-name",children:e.admin_name})]}),e.note&&(0,l.jsxs)("div",{className:"info-row note-row",children:[(0,l.jsx)("strong",{children:(0,s.__)("Note:","nobat")}),(0,l.jsx)("span",{className:"note-content",children:e.note})]}),"cancelled"===e.status&&e.cancellation_reason&&(0,l.jsxs)("div",{className:"info-row cancellation-row",children:[(0,l.jsx)("strong",{children:(0,s.__)("Cancellation Reason:","nobat")}),(0,l.jsx)("span",{className:"cancellation-reason",children:e.cancellation_reason})]})]}),N.length>0&&(0,l.jsxs)("div",{className:"appointment-actions",style:{marginTop:16,paddingTop:16,borderTop:"2px solid #e5e7eb"},children:[(0,l.jsx)("h4",{style:{marginBottom:12,fontSize:13,fontWeight:600,color:"#374151",letterSpacing:"0.025em"},children:(0,s.__)("Available Actions","nobat")}),(0,l.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:8},children:N.map((t,n)=>(0,l.jsx)(o.Button,{variant:t.variant,isDestructive:t.isDestructive,className:t.className,onClick:"status"===t.type?()=>(async t=>{await i(e.id,t)})(t.status):t.onClick,style:{width:"100%",justifyContent:"flex-start",height:"auto",padding:"10px 14px",textAlign:"left",whiteSpace:"normal"},children:(0,l.jsxs)("div",{style:{display:"flex",alignItems:"center",width:"100%"},children:[t.icon&&(0,l.jsx)("span",{style:{fontSize:"16px",marginRight:10,minWidth:"20px",textAlign:"center"},children:t.icon}),(0,l.jsxs)("div",{style:{flex:1,marginLeft:(t.icon,0)},children:[(0,l.jsx)("div",{style:{fontWeight:600,fontSize:"13px",marginBottom:t.description?"2px":0},children:t.label}),t.description&&(0,l.jsx)("div",{style:{fontSize:"11px",opacity:.75,lineHeight:1.3},children:t.description})]})]})},t.status||t.type||n))})]}),(0,l.jsxs)("div",{className:"appointment-report",style:{marginTop:24,paddingTop:20,borderTop:"2px solid #e5e7eb"},children:[(0,l.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[(0,l.jsx)("h4",{style:{fontSize:14,fontWeight:600,color:"#374151",letterSpacing:"0.025em",margin:0},children:(0,s.__)("Session Report","nobat")}),!v&&p&&(0,l.jsx)(o.Button,{variant:"link",onClick:()=>w(!0),style:{fontSize:13,padding:"4px 8px"},children:(0,s.__)("Edit","nobat")})]}),y&&(0,l.jsx)("div",{style:{padding:"10px 12px",marginBottom:12,borderRadius:6,fontSize:13,backgroundColor:"success"===y.type?"#d1fae5":"#fee2e2",color:"success"===y.type?"#065f46":"#991b1b",border:"1px solid "+("success"===y.type?"#6ee7b7":"#fca5a5")},children:y.text}),v?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(o.TextareaControl,{value:p,onChange:m,placeholder:(0,s.__)("Add notes, observations, or session summary...","nobat"),rows:2,style:{width:"100%",fontSize:14,lineHeight:1.5}}),(0,l.jsxs)("div",{style:{display:"flex",gap:8,marginTop:12},children:[(0,l.jsx)(o.Button,{variant:"primary",onClick:async()=>{f(!0),j(null);try{await h()({path:`/nobat/v2/appointments/${e.id}/report`,method:"PUT",data:{report:p}}),j({type:"success",text:(0,s.__)("Report saved successfully!","nobat")}),w(!1),setTimeout(()=>j(null),3e3)}catch(e){j({type:"error",text:e.message||(0,s.__)("Failed to save report","nobat")})}finally{f(!1)}},isBusy:b,disabled:b,style:{flex:1},children:b?(0,s.__)("Saving...","nobat"):(0,s.__)("Save Report","nobat")}),p&&e?.report&&(0,l.jsx)(o.Button,{variant:"secondary",onClick:()=>{m(e.report||""),w(!1)},disabled:b,children:(0,s.__)("Cancel","nobat")})]})]}):(0,l.jsx)("div",{style:{padding:"12px",backgroundColor:"#f9fafb",border:"1px solid #e5e7eb",borderRadius:6,fontSize:14,lineHeight:1.6,color:"#374151",whiteSpace:"pre-wrap"},children:p||(0,l.jsx)("span",{style:{color:"#9ca3af",fontStyle:"italic"},children:(0,s.__)("No report added yet","nobat")})})]})]})}),c&&(0,l.jsxs)(o.Modal,{title:(0,s.__)("Delete Appointment","nobat"),onRequestClose:()=>d(!1),children:[(0,l.jsx)("p",{children:(0,s.__)("Are you sure you want to delete this appointment? This action cannot be undone.","nobat")}),(0,l.jsxs)("div",{className:"modal-actions",style:{display:"flex",gap:8,marginTop:16,justifyContent:"flex-end"},children:[(0,l.jsx)(o.Button,{variant:"secondary",onClick:()=>d(!1),children:(0,s.__)("Cancel","nobat")}),(0,l.jsx)(o.Button,{variant:"primary",isDestructive:!0,onClick:async()=>{await r(e.id)&&(d(!1),n())},children:(0,s.__)("Delete","nobat")})]})]})]})},y=({appointment:e,onStatusUpdate:t,onDelete:n})=>{const[s,o]=(0,a.useState)(!1);return console.log("ðŸŽ¯ AppointmentSlot received appointment:",e),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"time-block clickable",style:{backgroundColor:u(e.status),borderLeftColor:b(e.status),cursor:"pointer"},onClick:()=>{console.log("ðŸ‘† Clicked appointment slot, opening modal with data:",e),o(!0)},children:(0,l.jsxs)("div",{className:"time-block-content",children:[(0,l.jsx)("div",{className:"client-name",children:e.user_name}),(0,l.jsx)("div",{className:"client-phone",children:e.user_phone})]})}),(0,l.jsx)(f,{appointment:e,isOpen:s,onClose:()=>o(!1),onStatusUpdate:t,onDelete:n})]})},j=({slot:e,date:t,onChangeStatus:n})=>{const[i,r]=(0,a.useState)(!1),c=(e=>{switch(e){case"booked":return{label:(0,s.__)("Booked","nobat"),className:"slot-booked"};case"blocked":return{label:(0,s.__)("Blocked","nobat"),className:"slot-blocked"};case"unavailable":return{label:(0,s.__)("Unavailable","nobat"),className:"slot-unavailable"};default:return{label:(0,s.__)("Available","nobat"),className:"slot-available"}}})(e?.status||"available"),d=()=>r(!1),p=(()=>{const t=e?.status||"available",n={makeAvailable:{label:(0,s.__)("Make Available","nobat"),description:(0,s.__)("Open this slot for booking","nobat"),status:"available",variant:"primary",icon:"âœ“"},block:{label:(0,s.__)("Block Slot","nobat"),description:(0,s.__)("Block this slot (lunch, meeting, etc)","nobat"),status:"blocked",variant:"secondary",icon:"ðŸš«"},makeUnavailable:{label:(0,s.__)("Make Unavailable","nobat"),description:(0,s.__)("Mark as outside working hours","nobat"),status:"unavailable",variant:"secondary",icon:"â¸"}};switch(t){case"available":return[n.block,n.makeUnavailable];case"blocked":return[n.makeAvailable,n.makeUnavailable];case"unavailable":return[n.makeAvailable,n.block];default:return[n.makeAvailable,n.block,n.makeUnavailable]}})();return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:`empty-slot clickable ${c.className}`,onClick:()=>{r(!0)},children:c.label}),i&&(0,l.jsx)(o.Modal,{title:(0,s.__)("Manage Time Slot","nobat"),onRequestClose:d,children:(0,l.jsxs)("div",{className:"slot-status-modal",children:[(0,l.jsxs)("div",{style:{marginBottom:20,padding:12,backgroundColor:"#f3f4f6",borderRadius:6},children:[(0,l.jsx)("div",{style:{fontSize:13,color:"#6b7280",marginBottom:4},children:(0,s.__)("Time Slot:","nobat")}),(0,l.jsxs)("div",{style:{fontSize:16,fontWeight:600,color:"#111827"},children:[e.start," - ",e.end]}),(0,l.jsxs)("div",{style:{fontSize:13,color:"#6b7280",marginTop:4},children:[(0,s.__)("Current Status:","nobat")," ",(0,l.jsx)("strong",{children:c.label})]})]}),p.length>0&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h4",{style:{marginBottom:12,fontSize:14,fontWeight:600,color:"#374151",letterSpacing:"0.025em"},children:(0,s.__)("Available Actions","nobat")}),(0,l.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:8},children:p.map(a=>(0,l.jsx)(o.Button,{variant:a.variant,onClick:()=>(async a=>{try{"function"==typeof n&&await n(t,`${e.start}-${e.end}`,a)}finally{d()}})(a.status),style:{width:"100%",justifyContent:"flex-start",height:"auto",padding:"12px 16px",textAlign:"left",whiteSpace:"normal"},children:(0,l.jsxs)("div",{style:{display:"flex",alignItems:"center",width:"100%"},children:[(0,l.jsx)("span",{style:{fontSize:"18px",marginRight:12,minWidth:"24px",textAlign:"center"},children:a.icon}),(0,l.jsxs)("div",{style:{flex:1},children:[(0,l.jsx)("div",{style:{fontWeight:600,fontSize:"14px",marginBottom:"2px"},children:a.label}),(0,l.jsx)("div",{style:{fontSize:"12px",opacity:.8,lineHeight:1.4},children:a.description})]})]})},a.status))})]}),(0,l.jsx)("div",{style:{marginTop:16,paddingTop:16,borderTop:"1px solid #e5e7eb"},children:(0,l.jsx)(o.Button,{variant:"tertiary",onClick:d,style:{width:"100%"},children:(0,s.__)("Close","nobat")})})]})})]})},v=({day:e,onStatusUpdate:t,onDelete:n,onChangeSlotStatus:a})=>{const s=(new Date).toISOString().split("T")[0],o=e.date===s;return(0,l.jsxs)("div",{className:"day-column "+(o?"today":""),children:[(0,l.jsx)("div",{children:(0,l.jsxs)("div",{className:"day-header",children:[(0,l.jsx)("div",{className:"day-name",children:e?.weekday}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"day-number",children:e?.day_number})," ",(0,l.jsx)("span",{className:"month-name",children:e?.month_name})," ",(0,l.jsx)("span",{className:"year-number",children:e?.year})]})]})}),(0,l.jsx)("div",{className:"time-slots",children:(e.slots||[]).map((s,o)=>{const i="unavailable"===s.status,r="booked"===s.status&&s.appointment,c=s.start?.endsWith(":00");return(0,l.jsx)("div",{className:`time-slot-container${i?" excluded":""}${c?" on-the-hour":""}`,children:(0,l.jsx)("div",{className:"time-slot-content",children:r?(0,l.jsx)(y,{appointment:s.appointment,onStatusUpdate:t,onDelete:n}):(0,l.jsx)(j,{slot:s,date:e.date,onChangeStatus:a})})},o)})})]})},w=()=>(0,l.jsxs)("div",{className:"calendar-no-schedule",children:[(0,l.jsx)("div",{className:"calendar-icon",children:"ðŸ“…"}),(0,l.jsx)("h3",{children:(0,s.__)("No Schedule Found","nobat")}),(0,l.jsx)("p",{children:(0,s.__)("You need to create a schedule before you can view the calendar.","nobat")}),(0,l.jsx)("a",{href:window.location.origin+"/wp-admin/admin.php?page=nobat-scheduling",className:"create-schedule-button",children:(0,s.__)("Create Your First Schedule Here","nobat")})]}),k=e=>{const t=e%60,n=e=>String(e).padStart(2,"0");return`${n(Math.floor(e/60)%24)}:${n(t)}`},N=e=>{if(!e||"string"!=typeof e)return null;const[t,n]=e.split(":").map(e=>parseInt(e,10));return Number.isNaN(t)||Number.isNaN(n)?null:60*t+n};function S(){return(0,l.jsx)("div",{className:"calendar-loading",children:(0,l.jsx)("p",{children:(0,s.__)("Loading calendar...","nobat")})})}function C({children:e}){return(0,l.jsx)("div",{className:"calendar-error",children:(0,l.jsx)("p",{children:e})})}const A=()=>{const{schedule:e,loading:t,error:n,refetch:o}=c(),i=e?.id,{appointments:r,loading:d,error:m,refetch:h}=(e=>{const[t,n]=(0,a.useState)([]),[s,o]=(0,a.useState)(!0),[l,i]=(0,a.useState)(null),r=(0,a.useCallback)(async()=>{try{o(!0),i(null);const t=e?`?schedule_id=${encodeURIComponent(e)}`:"",a=await fetch(`/wp-json/nobat/v2/appointments/all${t}`,{method:"GET",headers:{"Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce}});if(!a.ok)throw new Error("Failed to fetch appointments");const s=await a.json();console.log("ðŸ“¥ Raw API Response:",s);const l=s.appointments||s;console.log("ðŸ“‹ Extracted appointments:",l),console.log("ðŸ“Š First appointment sample:",l[0]),n(l)}catch(e){i(e.message),console.error("âŒ Error fetching appointments:",e)}finally{o(!1)}},[e]);return(0,a.useEffect)(()=>{r()},[r]),{appointments:t,loading:s,error:l,refetch:r}})(i),{handleStatusUpdate:u,handleDelete:b}=(()=>{const[e,t]=(0,a.useState)(null);return{handleStatusUpdate:(0,a.useCallback)(async(e,n)=>{try{if(t(null),!(await fetch(`/wp-json/nobat/v2/appointments/${e}`,{method:"PUT",headers:{"Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},body:JSON.stringify({status:n})})).ok)throw new Error("Failed to update appointment");return!0}catch(e){return t("Failed to update appointment status"),console.error("Error updating appointment status:",e),!1}},[]),handleDelete:(0,a.useCallback)(async e=>{try{if(t(null),!(await fetch(`/wp-json/nobat/v2/appointments/${e}`,{method:"DELETE",headers:{"X-WP-Nonce":wpApiSettings.nonce}})).ok)throw new Error("Failed to delete appointment");return!0}catch(e){return t("Failed to delete appointment"),console.error("Error deleting appointment:",e),!1}},[]),error:e}})(),_=Number(e?.meeting_duration||30),{updateSlotStatus:x,handleStatusUpdateWithRefresh:g,handleDeleteWithRefresh:f}=((e,{refetchSchedule:t,refetchAppointments:n},{handleStatusUpdate:a,handleDelete:s})=>({updateSlotStatus:async(n,a,s)=>{try{const o=await fetch("/wp-json/nobat/v2/schedules/slot",{method:"PUT",headers:{"Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},body:JSON.stringify({schedule_id:e,date:n,time_slot:a,status:s})});if(!o.ok)throw new Error("Failed to update slot status");await o.json().catch(()=>({})),t()}catch(e){console.error(e)}},handleStatusUpdateWithRefresh:async(e,t)=>{const s=await a(e,t);return s&&n(),s},handleDeleteWithRefresh:async e=>{console.log("ðŸ—‘ï¸ Deleting appointment:",e);const a=await s(e);return a?(console.log("âœ… Appointment deleted successfully, refreshing data..."),await n(),await t(),console.log("ðŸ”„ Data refreshed - slot should now be available")):console.error("âŒ Failed to delete appointment"),a}}))(i,{refetchSchedule:o,refetchAppointments:h},{handleStatusUpdate:u,handleDelete:b}),{normalizedDays:y,timeRows:j}=((e,t,n)=>{const a=Array.isArray(e?.timeslots)?e.timeslots:[],s=((e,t)=>{const n=[];if(t<=0)return n;const{start:a,end:s}=(e=>{let t=1/0,n=-1/0;return Array.isArray(e)&&e.forEach(e=>{(Array.isArray(e?.slots)?e.slots:[]).forEach(e=>{const a=N(e?.start),s=N(e?.end);null!=a&&null!=s&&(a<t&&(t=a),s>n&&(n=s))})}),!Number.isFinite(t)||!Number.isFinite(n)||t>=n?{start:0,end:1440}:{start:t,end:n}})(e);let o=a;for(;o+t<=s;){const e=o+t;n.push({start:k(o),end:k(e),key:`${k(o)}-${k(e)}`}),o=e}return n})(e?.timeslots,n);console.log("ðŸ—“ï¸ useNormalizedDays - appointments received:",t),console.log("ðŸ—“ï¸ useNormalizedDays - days:",a.length);const o=new Map((Array.isArray(t)?t:[]).map(e=>{const t=`${e.slot_date} ${e.start_time?.substring(0,5)}-${e.end_time?.substring(0,5)}`;return console.log(`ðŸ”‘ Creating map key: "${t}" for appointment:`,e),[t,e]}));return console.log("ðŸ—ºï¸ appointmentByDateSlot Map:",Array.from(o.entries())),{normalizedDays:a.map(e=>{const t=new Map((Array.isArray(e?.slots)?e.slots:[]).map(e=>[`${e.start}-${e.end}`,e])),n=s.map(n=>{const a=t.get(n.key);if(a){if("booked"===a.status){const t=`${e.date} ${n.key}`;console.log(`ðŸ” Looking for appointment with key: "${t}"`);const s=o.get(t);return s?(console.log("âœ… Found appointment:",s),{...a,appointment:s}):(console.log(`âŒ No appointment found for key: "${t}"`),a)}return a}return{start:n.start,end:n.end,status:"unavailable"}});return{...e,slots:n}}),timeRows:s}})(e,r,_);return t||d?(0,l.jsx)(S,{}):e&&e.id?m||n?(0,l.jsx)(C,{children:(0,s.__)("Error loading Calendar:","nobat")}):(0,l.jsxs)("div",{className:"calendar-grid",style:{gridTemplateColumns:`100px repeat(${y.length}, 120px)`},children:[(0,l.jsx)(p,{timeRows:j}),y.map(e=>(0,l.jsx)(v,{day:e,onStatusUpdate:g,onChangeSlotStatus:x,onDelete:f},e.date))]}):(0,l.jsx)(w,{})},T=()=>{const[e,t]=(0,a.useState)(null),n={available:{title:(0,s.__)("Available","nobat"),color:"transparent",borderColor:"#4caf50",description:(0,s.__)("Open time slots that users can book","nobat"),details:(0,s.__)("These slots are within your working hours and ready for booking. Users can select and book these times.","nobat"),example:(0,s.__)("Example: Monday 9:00 AM - 10:00 AM is available for booking","nobat")},booked:{title:(0,s.__)("Booked","nobat"),color:"#4caf50",description:(0,s.__)("Time slot has an active appointment","nobat"),details:(0,s.__)("A user has booked this time slot. Click on a booked slot to view appointment details, contact information, and manage the appointment.","nobat"),example:(0,s.__)("Example: Monday 10:00 AM - 11:00 AM is booked by John Doe","nobat")},blocked:{title:(0,s.__)("Blocked","nobat"),color:"#f44336",description:(0,s.__)("Manually blocked by admin","nobat"),details:(0,s.__)("These slots are within working hours but you've manually disabled them. Users cannot book blocked slots. Use this for lunch breaks, meetings, or temporary closures.","nobat"),example:(0,s.__)("Example: Block 12:00 PM - 1:00 PM for lunch break","nobat")},unavailable:{title:(0,s.__)("Unavailable","nobat"),color:"#9e9e9e",description:(0,s.__)("Outside working hours","nobat"),details:(0,s.__)("These time slots are not part of your defined schedule. They appear as placeholders in the calendar but cannot be booked or modified.","nobat"),example:(0,s.__)("Example: If schedule is 9 AM - 5 PM, then 8 AM is unavailable","nobat")}},i=e=>{t(e)};return(0,l.jsxs)("div",{className:"calendar-view",children:[(0,l.jsx)("div",{className:"calendar-header",children:(0,l.jsx)(d,{})}),(0,l.jsx)("div",{className:"calendar-legend",children:(0,l.jsxs)("div",{className:"legend-items",children:[(0,l.jsxs)("div",{className:"legend-item clickable",onClick:()=>i("available"),title:(0,s.__)("Click for details","nobat"),children:[(0,l.jsx)("span",{className:"legend-color slot-available"}),(0,l.jsx)("span",{className:"legend-label",children:(0,s.__)("Available","nobat")}),(0,l.jsx)("span",{className:"legend-info-icon",children:"â“˜"})]}),(0,l.jsxs)("div",{className:"legend-item clickable",onClick:()=>i("booked"),title:(0,s.__)("Click for details","nobat"),children:[(0,l.jsx)("span",{className:"legend-color slot-booked"}),(0,l.jsx)("span",{className:"legend-label",children:(0,s.__)("Booked","nobat")}),(0,l.jsx)("span",{className:"legend-info-icon",children:"â“˜"})]}),(0,l.jsxs)("div",{className:"legend-item clickable",onClick:()=>i("blocked"),title:(0,s.__)("Click for details","nobat"),children:[(0,l.jsx)("span",{className:"legend-color slot-blocked"}),(0,l.jsx)("span",{className:"legend-label",children:(0,s.__)("Blocked","nobat")}),(0,l.jsx)("span",{className:"legend-info-icon",children:"â“˜"})]}),(0,l.jsxs)("div",{className:"legend-item clickable",onClick:()=>i("unavailable"),title:(0,s.__)("Click for details","nobat"),children:[(0,l.jsx)("span",{className:"legend-color slot-unavailable"}),(0,l.jsx)("span",{className:"legend-label",children:(0,s.__)("Unavailable","nobat")}),(0,l.jsx)("span",{className:"legend-info-icon",children:"â“˜"})]})]})}),e&&(0,l.jsx)(o.Modal,{title:n[e].title,onRequestClose:()=>t(null),className:"status-info-modal",children:(0,l.jsxs)("div",{className:"status-modal-content",children:[(0,l.jsxs)("div",{className:"status-color-preview",children:[(0,l.jsx)("span",{className:"color-box",style:{backgroundColor:n[e].color,border:n[e].borderColor?`2px solid ${n[e].borderColor}`:"1px solid rgba(0,0,0,0.15)",width:"60px",height:"40px",borderRadius:"6px",display:"inline-block"}}),(0,l.jsx)("span",{className:"status-name",children:n[e].title})]}),(0,l.jsxs)("div",{className:"status-section",children:[(0,l.jsx)("h4",{children:(0,s.__)("Description","nobat")}),(0,l.jsx)("p",{children:n[e].description})]}),(0,l.jsxs)("div",{className:"status-section",children:[(0,l.jsx)("h4",{children:(0,s.__)("Details","nobat")}),(0,l.jsx)("p",{children:n[e].details})]}),(0,l.jsxs)("div",{className:"status-section example",children:[(0,l.jsx)("h4",{children:(0,s.__)("Example","nobat")}),(0,l.jsx)("p",{children:n[e].example})]}),(0,l.jsx)("div",{className:"modal-actions",children:(0,l.jsx)(o.Button,{variant:"primary",onClick:()=>t(null),children:(0,s.__)("Got it","nobat")})})]})}),(0,l.jsx)(A,{})]})};n()(()=>{const e=(0,a.createRoot)(document.getElementById("nobat-cal")),t=new URL(window.location.href).searchParams.get("schedule_id"),n=t?Number(t):void 0;e.render((0,l.jsx)(r,{scheduleId:n,children:(0,l.jsx)(T,{})}))})})();